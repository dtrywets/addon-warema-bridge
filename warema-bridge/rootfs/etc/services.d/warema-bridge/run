#!/usr/bin/with-contenv bashio
# ==============================================================================
# Home Assistant Community Add-on: Warema Bridge
# Runs the Warema bridge
# ==============================================================================

bashio::log.info 'Starting the Warema bridge...'

# 1) klassische WMS-Werte laden
for var in WMS_KEY WMS_PAN_ID WMS_CHANNEL WMS_SERIAL_PORT IGNORED_DEVICES FORCE_DEVICES; do
  key=${var,,}   # Lowercase, z.B. wms_key
  if bashio::config.has_value "${key}"; then
    value=$(bashio::config "${key}")
    bashio::log.info "Setting ${var} to ${value}"
    export "${var}=${value}"
  fi
done

# 2) MQTT-Werte aus dem verschachtelten Objekt mqtt: { server, user, password }
if bashio::config.has_value 'mqtt.server'; then
  MQTT_SERVER=$(bashio::config 'mqtt.server')
  bashio::log.info "Setting MQTT_SERVER to ${MQTT_SERVER}"
  export MQTT_SERVER
fi
if bashio::config.has_value 'mqtt.user'; then
  MQTT_USER=$(bashio::config 'mqtt.user')
  bashio::log.info "Setting MQTT_USER to ${MQTT_USER}"
  export MQTT_USER
fi
if bashio::config.has_value 'mqtt.password'; then
  MQTT_PASSWORD=$(bashio::config 'mqtt.password')
  bashio::log.info "Setting MQTT_PASSWORD to ${MQTT_PASSWORD}"
  export MQTT_PASSWORD
fi

# 3) Fallback/Auto-Discovery wie gehabt
if ! bashio::services.available "mqtt" && ! bashio::config.exists 'mqtt.server'; then
    bashio::exit.nok "No internal MQTT service found and no MQTT server defined."
else
    bashio::log.info "MQTT available, checking configuration ..."
    if ! bashio::config.has_value 'mqtt.server'; then
        bashio::log.info "No mqtt.server, attempting auto-discovery..."
        MQTT_PREFIX="mqtt://"
        if [ "$(bashio::services mqtt "ssl")" = true ]; then
            MQTT_PREFIX="mqtts://"
        fi
        export MQTT_SERVER="${MQTT_PREFIX}$(bashio::services mqtt "host"):$(bashio::services mqtt "port")"
        bashio::log.info "Discovered MQTT_SERVER=${MQTT_SERVER}"
    fi
    if ! bashio::config.has_value 'mqtt.user'; then
        bashio::log.info "No mqtt.user, attempting auto-discovery..."
        export MQTT_USER=$(bashio::services mqtt "username")
        export MQTT_PASSWORD=$(bashio::services mqtt "password")
        bashio::log.info "Discovered MQTT_USER=${MQTT_USER}"
    fi
fi

# Finally start the bridge
exec node /srv/bridge.js
